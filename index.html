<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JioPay Support Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .chat-container {
        height: calc(100vh - 200px);
        background: linear-gradient(to bottom, #f8faff, #ffffff);
      }
      .message-bubble {
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .typing-indicator {
        animation: pulse 1.5s ease-in-out infinite;
      }
      .source-card {
        transition: all 0.3s ease;
      }
      .source-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }
      .glassmorphism {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
      <div class="container mx-auto px-4 py-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div
              class="w-10 h-10 bg-white rounded-lg flex items-center justify-center"
            >
              <i class="fas fa-robot text-purple-600 text-xl"></i>
            </div>
            <div>
              <h1 class="text-2xl font-bold">JioPay Support Assistant</h1>
              <p class="text-purple-100">Powered by RAG Technology</p>
            </div>
          </div>
          <div class="flex items-center space-x-4 text-sm">
            <div id="systemStatus" class="flex items-center space-x-2">
              <div
                class="w-3 h-3 bg-green-400 rounded-full animate-pulse"
              ></div>
              <span>System Online</span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-6 flex gap-6">
      <!-- Chat Section -->
      <div class="flex-1 bg-white rounded-xl shadow-xl overflow-hidden">
        <!-- Chat Header -->
        <div
          class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4"
        >
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Chat with Support Assistant</h2>
            <div id="statsDisplay" class="text-sm text-blue-100">
              <span id="queryCount">0 queries</span> â€¢
              <span id="avgLatency">0ms avg</span>
            </div>
          </div>
        </div>

        <!-- Chat Messages -->
        <div id="chatContainer" class="chat-container p-4 overflow-y-auto">
          <div class="space-y-4">
            <!-- Welcome Message -->
            <div class="message-bubble flex items-start space-x-3">
              <div
                class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center"
              >
                <i class="fas fa-robot text-purple-600"></i>
              </div>
              <div class="flex-1">
                <div class="bg-gray-100 rounded-lg p-3 max-w-md">
                  <p class="text-gray-800">
                    Hello! I'm your JioPay support assistant. I can help you
                    with questions about payments, KYC, refunds, security, and
                    more. What can I help you with today?
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Input -->
        <div class="border-t bg-gray-50 p-4">
          <div class="flex space-x-3">
            <input
              type="text"
              id="messageInput"
              placeholder="Ask me about JioPay services..."
              class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
              maxlength="500"
            />
            <button
              id="sendButton"
              class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <i class="fas fa-paper-plane"></i>
              <span class="ml-2">Send</span>
            </button>
          </div>
          <div
            class="flex items-center justify-between text-xs text-gray-500 mt-2"
          >
            <span>Press Enter to send</span>
            <span id="charCount">0/500</span>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="w-80 space-y-4">
        <!-- Performance Stats -->
        <div class="bg-white rounded-xl shadow-lg p-4">
          <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
            <i class="fas fa-chart-line text-blue-500 mr-2"></i>
            Performance
          </h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600">Total Queries:</span>
              <span id="totalQueries" class="font-semibold">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Avg Response:</span>
              <span id="avgResponseTime" class="font-semibold">0ms</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Avg Tokens:</span>
              <span id="avgTokens" class="font-semibold">0</span>
            </div>
          </div>
        </div>

        <!-- Recent Sources -->
        <div class="bg-white rounded-xl shadow-lg p-4">
          <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
            <i class="fas fa-link text-green-500 mr-2"></i>
            Recent Sources
          </h3>
          <div id="recentSources" class="space-y-2 text-sm text-gray-600">
            <p>Sources will appear here after queries</p>
          </div>
        </div>

        <!-- Example Queries -->
        <div class="bg-white rounded-xl shadow-lg p-4">
          <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
            Try Asking
          </h3>
          <div class="space-y-2">
            <button
              class="example-query w-full text-left p-2 bg-gray-50 rounded hover:bg-purple-50 hover:text-purple-600 transition-colors text-sm"
            >
              How do I complete my KYC verification?
            </button>
            <button
              class="example-query w-full text-left p-2 bg-gray-50 rounded hover:bg-purple-50 hover:text-purple-600 transition-colors text-sm"
            >
              What are the payment options available?
            </button>
            <button
              class="example-query w-full text-left p-2 bg-gray-50 rounded hover:bg-purple-50 hover:text-purple-600 transition-colors text-sm"
            >
              How do I request a refund?
            </button>
            <button
              class="example-query w-full text-left p-2 bg-gray-50 rounded hover:bg-purple-50 hover:text-purple-600 transition-colors text-sm"
            >
              What security measures does JioPay have?
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Source Modal -->
    <div
      id="sourceModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-white rounded-xl p-6 max-w-2xl max-h-96 overflow-auto m-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Source Details</h3>
          <button id="closeModal" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="sourceContent" class="text-gray-700">
          <!-- Source content will be populated here -->
        </div>
      </div>
    </div>

    <script>
      // Configuration
      const API_BASE_URL = "http://localhost:5000";

      // Global state
      let isTyping = false;
      let currentMessageId = 0;
      let queryStats = {
        total: 0,
        totalLatency: 0,
        totalTokens: 0,
      };

      // DOM Elements
      const chatContainer = document.getElementById("chatContainer");
      const messageInput = document.getElementById("messageInput");
      const sendButton = document.getElementById("sendButton");
      const charCount = document.getElementById("charCount");

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        setupEventListeners();
        checkSystemHealth();
        loadStats();
      });

      function setupEventListeners() {
        // Send message handlers
        sendButton.addEventListener("click", sendMessage);
        messageInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        // Character count
        messageInput.addEventListener("input", function () {
          charCount.textContent = `${this.value.length}/500`;
        });

        // Example queries
        document.querySelectorAll(".example-query").forEach((button) => {
          button.addEventListener("click", function () {
            messageInput.value = this.textContent;
            sendMessage();
          });
        });

        // Modal handlers
        document
          .getElementById("closeModal")
          .addEventListener("click", closeModal);
        document
          .getElementById("sourceModal")
          .addEventListener("click", function (e) {
            if (e.target === this) closeModal();
          });
      }

      async function checkSystemHealth() {
        try {
          const response = await fetch(`${API_BASE_URL}/health`);
          const data = await response.json();

          const statusEl = document.getElementById("systemStatus");
          if (response.ok) {
            statusEl.innerHTML =
              '<div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div><span>System Online</span>';
          } else {
            statusEl.innerHTML =
              '<div class="w-3 h-3 bg-red-400 rounded-full"></div><span>System Offline</span>';
          }
        } catch (error) {
          document.getElementById("systemStatus").innerHTML =
            '<div class="w-3 h-3 bg-red-400 rounded-full"></div><span>Connection Error</span>';
        }
      }

      async function loadStats() {
        try {
          const response = await fetch(`${API_BASE_URL}/stats`);
          const data = await response.json();

          updateStatsDisplay(data);
        } catch (error) {
          console.error("Error loading stats:", error);
        }
      }

      function updateStatsDisplay(stats) {
        document.getElementById("totalQueries").textContent =
          stats.total_queries;
        document.getElementById("avgResponseTime").textContent = `${Math.round(
          stats.avg_latency_ms
        )}ms`;
        document.getElementById("avgTokens").textContent = Math.round(
          stats.avg_tokens_used
        );

        document.getElementById(
          "queryCount"
        ).textContent = `${stats.total_queries} queries`;
        document.getElementById("avgLatency").textContent = `${Math.round(
          stats.avg_latency_ms
        )}ms avg`;
      }

      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || isTyping) return;

        // Add user message to chat
        addMessage(message, "user");
        messageInput.value = "";
        charCount.textContent = "0/500";

        // Disable input while processing
        setInputState(false);

        // Show typing indicator
        const typingId = showTypingIndicator();

        try {
          const response = await fetch(`${API_BASE_URL}/query`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ question: message }),
          });

          const data = await response.json();

          // Remove typing indicator
          removeMessage(typingId);

          if (response.ok && data.status === "success") {
            // Add assistant response
            addMessage(data.answer, "assistant", {
              sources: data.sources,
              latency: data.latency_ms,
              tokens: data.tokens_used,
            });

            // Update stats
            queryStats.total++;
            queryStats.totalLatency += data.latency_ms;
            queryStats.totalTokens += data.tokens_used;

            updateRecentSources(data.sources);
            updateLocalStats();
          } else {
            addMessage(
              data.message ||
                "Sorry, I encountered an error. Please try again.",
              "assistant",
              { isError: true }
            );
          }
        } catch (error) {
          removeMessage(typingId);
          addMessage(
            "Sorry, I could not connect to the server. Please check your connection and try again.",
            "assistant",
            { isError: true }
          );
          console.error("Error:", error);
        }

        // Re-enable input
        setInputState(true);
      }

      function addMessage(content, sender, metadata = {}) {
        const messageId = currentMessageId++;
        const messageDiv = document.createElement("div");
        messageDiv.className = "message-bubble flex items-start space-x-3";
        messageDiv.id = `message-${messageId}`;

        if (sender === "user") {
          messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center ml-auto order-2">
                        <i class="fas fa-user text-blue-600"></i>
                    </div>
                    <div class="flex-1 order-1">
                        <div class="bg-blue-600 text-white rounded-lg p-3 max-w-md ml-auto">
                            <p>${escapeHtml(content)}</p>
                        </div>
                    </div>
                `;
        } else {
          const isError = metadata.isError || false;
          const bgColor = isError ? "bg-red-100" : "bg-gray-100";
          const textColor = isError ? "text-red-800" : "text-gray-800";

          let sourcesHtml = "";
          if (metadata.sources && metadata.sources.length > 0) {
            sourcesHtml = `
                        <div class="mt-3 space-y-2">
                            <div class="text-xs text-gray-500 font-medium">Sources:</div>
                            <div class="space-y-1">
                                ${metadata.sources
                                  .map(
                                    (source, index) => `
                                    <button 
                                        class="source-card text-left w-full p-2 bg-white border rounded-lg hover:shadow-md transition-all text-xs"
                                        onclick="showSourceDetails(${JSON.stringify(
                                          source
                                        ).replace(/"/g, "&quot;")})"
                                    >
                                        <div class="flex items-center justify-between">
                                            <span class="font-medium text-purple-600">${
                                              source.source
                                            }</span>
                                            <span class="text-gray-400">Score: ${(
                                              source.score * 100
                                            ).toFixed(1)}%</span>
                                        </div>
                                        <div class="text-gray-600 mt-1 line-clamp-2">${escapeHtml(
                                          source.text
                                        )}</div>
                                    </button>
                                `
                                  )
                                  .join("")}
                            </div>
                        </div>
                    `;
          }

          let metadataHtml = "";
          if (metadata.latency && metadata.tokens) {
            metadataHtml = `
                        <div class="mt-2 text-xs text-gray-400 flex items-center space-x-3">
                            <span><i class="fas fa-clock mr-1"></i>${Math.round(
                              metadata.latency
                            )}ms</span>
                            <span><i class="fas fa-coins mr-1"></i>${
                              metadata.tokens
                            } tokens</span>
                        </div>
                    `;
          }

          messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-purple-600"></i>
                    </div>
                    <div class="flex-1">
                        <div class="${bgColor} rounded-lg p-3 max-w-2xl">
                            <p class="${textColor}">${escapeHtml(content)}</p>
                            ${sourcesHtml}
                            ${metadataHtml}
                        </div>
                    </div>
                `;
        }

        chatContainer.querySelector(".space-y-4").appendChild(messageDiv);
        scrollToBottom();

        return messageId;
      }

      function showTypingIndicator() {
        const typingId = currentMessageId++;
        const typingDiv = document.createElement("div");
        typingDiv.className = "message-bubble flex items-start space-x-3";
        typingDiv.id = `message-${typingId}`;
        typingDiv.innerHTML = `
                <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-robot text-purple-600"></i>
                </div>
                <div class="flex-1">
                    <div class="bg-gray-100 rounded-lg p-3 max-w-md">
                        <div class="typing-indicator flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                </div>
            `;

        chatContainer.querySelector(".space-y-4").appendChild(typingDiv);
        scrollToBottom();
        isTyping = true;

        return typingId;
      }

      function removeMessage(messageId) {
        const messageEl = document.getElementById(`message-${messageId}`);
        if (messageEl) {
          messageEl.remove();
        }
        isTyping = false;
      }

      function setInputState(enabled) {
        messageInput.disabled = !enabled;
        sendButton.disabled = !enabled;

        if (enabled) {
          messageInput.focus();
          sendButton.classList.remove("opacity-50", "cursor-not-allowed");
        } else {
          sendButton.classList.add("opacity-50", "cursor-not-allowed");
        }
      }

      function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function updateRecentSources(sources) {
        const recentSourcesEl = document.getElementById("recentSources");
        const sourceItems = sources
          .slice(0, 3)
          .map(
            (source) => `
                <div class="p-2 bg-gray-50 rounded text-xs">
                    <div class="font-medium text-purple-600">${
                      source.source
                    }</div>
                    <div class="text-gray-600 truncate">${escapeHtml(
                      source.text.substring(0, 50)
                    )}...</div>
                </div>
            `
          )
          .join("");

        recentSourcesEl.innerHTML = sourceItems || "<p>No sources yet</p>";
      }

      function updateLocalStats() {
        const avgLatency =
          queryStats.total > 0 ? queryStats.totalLatency / queryStats.total : 0;
        const avgTokens =
          queryStats.total > 0 ? queryStats.totalTokens / queryStats.total : 0;

        document.getElementById("totalQueries").textContent = queryStats.total;
        document.getElementById("avgResponseTime").textContent = `${Math.round(
          avgLatency
        )}ms`;
        document.getElementById("avgTokens").textContent =
          Math.round(avgTokens);

        document.getElementById(
          "queryCount"
        ).textContent = `${queryStats.total} queries`;
        document.getElementById("avgLatency").textContent = `${Math.round(
          avgLatency
        )}ms avg`;
      }

      function showSourceDetails(source) {
        const modal = document.getElementById("sourceModal");
        const content = document.getElementById("sourceContent");

        content.innerHTML = `
                <div class="space-y-4">
                    <div class="border-l-4 border-purple-500 pl-4">
                        <h4 class="font-medium text-purple-700">${
                          source.source
                        }</h4>
                        <p class="text-sm text-gray-500">Relevance Score: ${(
                          source.score * 100
                        ).toFixed(1)}%</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-700 whitespace-pre-wrap">${escapeHtml(
                          source.text
                        )}</p>
                    </div>
                </div>
            `;

        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      function closeModal() {
        const modal = document.getElementById("sourceModal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }

      // Refresh stats periodically
      setInterval(loadStats, 30000); // Every 30 seconds
      setInterval(checkSystemHealth, 60000); // Every minute
    </script>
  </body>
</html>
